{% extends "header.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_head %}
<style>
    /* Ocultar el contenido inmediatamente */
    body {
        visibility: hidden;
    }
    .preload * {
        transition: none !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Pantalla de carga -->
{% include 'includes/loading.html' %}

<!-- Contenido del login -->
<div class="background fade-in"></div>
<div id="main-login" class="fade-in-delayed">
    {% include 'includes/messaging.html' %}
    <div class="content-section">
        <form method="POST" class="form-style">
            {% csrf_token %}
            <fieldset class="form-group">
                <legend class="border-bottom mb-4">Iniciar sesión</legend>
                {{ form|crispy }}
                
                <!-- Agregar selector de sección solo para estudiantes -->
                <div class="form-group" id="section-group" style="display: none;">
                    <label for="section-select">Seleccionar Sección:</label>
                    <select class="form-control" id="section-select" name="section">
                        <option value="">Seleccionar Sección</option>
                        {% for section in sections %}
                            <option value="{{ section.id }}">{{ section.code }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-button">
                    <button class="btn btn-outline-info" type="submit">Ingresar</button>
                    <small class="text-muted">
                        <a href="{% url 'password_reset' %}">Olvidaste tu contraseña?</a>
                    </small>
                </div>
            </fieldset>
            <div class="fondo">
                <img src="{% static 'images/bg_login.jpeg' %}" alt="Logo de Duoc UC">
            </div>
        </form>

        <div class="border-top pt-3">
            <small class="text-muted">
                Crear una cuenta? <a class="ml-2" href="{% url 'register' %}">¡Registrate ahora!</a>
            </small>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const usernameField = document.querySelector('[name="username"]');
    const sectionGroup = document.getElementById('section-group');
    const sectionSelect = document.getElementById('section-select');
    const form = document.querySelector('form');

    async function checkUserRole(username) {
        try {
            const response = await fetch(`/users/check-user-role/?username=${username}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            if (data.role === 'STUDENT') {
                sectionGroup.style.display = 'block';
                sectionSelect.required = true;
            } else {
                sectionGroup.style.display = 'none';
                sectionSelect.required = false;
            }
        } catch (error) {
            console.error('Error:', error);
            sectionGroup.style.display = 'none';
            sectionSelect.required = false;
        }
    }

    usernameField.addEventListener('change', function() {
        const username = this.value;
        if (username) {
            checkUserRole(username);
        }
    });

    form.addEventListener('submit', function(e) {
        if (sectionGroup.style.display === 'block' && !sectionSelect.value) {
            e.preventDefault();
            alert('Por favor seleccione una sección');
        }
    });
});
</script>
{% endblock %}